<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="dcterms.date" content="2021-09-23">
  <title>Dimensional and Rotational Testing of MOM6</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="./reveal.js/dist/reveal.css">
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="./reveal.js/css/theme/gfdl.css" id="theme">
  <!-- Explicitly add zenburn for highlight support -->
  <link rel="stylesheet" href="./reveal.js/plugin/highlight/zenburn.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? './reveal.js/css/print/pdf.scss' : './reveal.js/css/print/paper.scss';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="./reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
  <base href="./index.html">
</head>
<body>
  <div class="reveal"
       style="background: url(img/bg_gfdl.jpg);
              background-size: cover;">

    <!-- Original ratio: 10.04" x 7.08" -->
    <!--
    <div style="height: 100vh; position: absolute; bottom: -50vh; left: -40vh">
      <img style="height: 100vh; width: 142vh" src="img/bg_globe.png">
    </div>
    -->

    <header style="width: 10vh; position: absolute; bottom: 2vh; right: 2vh;">
      <img src="img/noaa_logo.png">
    </header>

    <footer style="font-size: 1pc; position: absolute; bottom: 2%; left: 2%;">
      <!-- code>https://marshallward.org/mom6vv</code> -->
      <code><p><a href="https://marshallward.org/fortrancon2021/index.html">https://marshallward.org/fortrancon2021/index.html</a></p></code>
    </footer>

    <div class="slides">

<section id="title-slide">
  <!--div class="reveal" style="text-align: right;">
    <img src="img/noaa_logo.png"
         style="background: none; border: none; box-shadow: none;
         width: 30%"
         alt="NCI">
  </div-->
  <h1 class="title">Dimensional and Rotational Testing of MOM6</h1>
  <p class="author" style="text-align: right;"><ul>
<li>Robert Hallberg</li>
<li><strong>Marshall Ward</strong></li>
<li>Alistair Adcroft</li>
</ul></p>
  <p class="date" style="text-align: right;">2021-09-23</p>
  <!-- Currently cannot add notes to a title slide, so have to do manually-->
  <aside class="notes">
    <p>Will talk about (bit repro testing)</p>
    <p>Although I am presenting...</p>
    <p>Robert Hallberg is responsible for many of the ideas here</p>
    <p>Had the audacity to assert that this was achievable.</p>
    <p>and fleshed them out with Alistair Adcroft, both at GFDL in Princeton.</p>
    <p>I just came in at the end and implemented them.</p>
  </aside>
</section>

<section id="global-modeling" class="title-slide slide level1">
<h1>Global Modeling</h1>
<p><video data-src="media/mom6_relvort.mp4" style="width:85.0%" controls=""><a href="media/mom6_relvort.mp4">image</a></video></p>
<aside class="notes">
<dl>
<dt>GFDL CM4 model:</dt>
<dd><ul>
<li>coupled to MOM6</li>
</ul>
</dd>
<dt>Phenomena on this model:</dt>
<dd><ul>
<li><dl>
<dt>Equatorial Waves</dt>
<dd><ul>
<li>Large, very fast</li>
<li>shelf-reflecting =&gt; ENSO</li>
</ul>
</dd>
</dl></li>
<li><dl>
<dt>Southern Ocean</dt>
<dd><ul>
<li>Slower, turbulent eddies</li>
<li>Strong topographic driven</li>
</ul>
</dd>
</dl></li>
<li><dl>
<dt>Western Boundary Currents</dt>
<dd><ul>
<li>Gulf Stream (Eastern US), Kuroshio (Japan)</li>
<li>Agulhas (Africa) -&gt; eddies</li>
<li>Benguela (S.America), EAC (Australia)</li>
</ul>
</dd>
</dl></li>
<li>Tropical storms (from atm)</li>
</ul>
</dd>
<dt>Things you cannot see</dt>
<dd><ul>
<li>very fast, very large scale, tidal waves</li>
<li>Meridional overturning circulation</li>
</ul>
</dd>
</dl>
</aside>
</section>

<section id="regional-modeling" class="title-slide slide level1">
<h1>Regional Modeling</h1>
<p><video data-src="media/mom6_regional.mp4" style="width:90.0%" controls=""><a href="media/mom6_regional.mp4">image</a></video></p>
<aside class="notes">
<p>Say something interesting...</p>
<ul>
<li>Fisheries</li>
<li>Refineries (Gulf of Mexico)</li>
<li>...?</li>
</ul>
</aside>
</section>

<section>
<section id="ocean-dynamics" class="title-slide slide level1">
<h1>Ocean Dynamics</h1>
<p><img data-src="img/ocn_finite_volume.png" alt="image" /></p>
<aside class="notes">
<ul>
<li><p><em>Very strong</em> parallels to atmosphere dynamics</p>
<ul>
<li>Ocean is like an "upside down atmosphere"</li>
</ul></li>
<li><p>Primarily finite volume:</p>
<ul>
<li>Momentum balance ("newton's law")</li>
<li>Hydrostatic balance =&gt; No elliptic PDEs (horizontally)</li>
<li>Advection of heat, salt, biomass, etc</li>
<li>Usually Boussinesq (volume-conserving)</li>
<li>Coriolis force is a major driver</li>
</ul></li>
<li><p>External forcing (heat, precip, wind)</p>
<blockquote>
<p>Sometimes prescribed, sometimes from another model</p>
</blockquote></li>
<li><p>Many "submodels":</p>
<ul>
<li>"LES"-like parameterizations</li>
<li>Complex vertical mixing</li>
<li>Boundary layers in surface, shelf</li>
</ul></li>
</ul>
</aside>
</section>
<section id="ocean-dynamics-1" class="slide level2">
<h2>Ocean Dynamics</h2>
<p><span class="math display">\[\begin{aligned}
\frac{D\mathbf{u}}{Dt} + f \hat{z} \times \mathbf{u} &amp;= -\nabla p + \mathcal{F} \\
p_z &amp;= -g \rho \\
\frac{D\phi}{Dt} &amp;= \mathcal{F}_\phi \\
\nabla \cdot \mathbf{u} + w_z &amp;= 0 \\
\rho &amp;= f(p, T, S, ...)
\end{aligned}\]</span></p>
</section></section>
<section id="layered-dynamics" class="title-slide slide level1">
<h1>Layered Dynamics</h1>
<p><img data-src="img/mom6_vcoord.png" style="width:75.0%" alt="image" /></p>
</section>

<section id="lagrangian-remap" class="title-slide slide level1">
<h1>Lagrangian Remap</h1>
<p><img data-src="img/lagrange_remap.png" alt="image" /></p>
</section>

<section id="chaotic-dynamics" class="title-slide slide level1">
<h1>Chaotic Dynamics</h1>
<figure>
<video data-src="media/pv.mp4" controls=""><a href="media/pv.mp4">Video</a></video>
</figure>
</section>

<section id="motivation" class="title-slide slide level1">
<h1>Motivation</h1>
<ul>
<li>Accurate preservation of tracers</li>
<li>Sustain long simulations over decades, centuries</li>
<li>Residual noise can cause chaotic growth</li>
<li>Operational work needs robust testing</li>
</ul>
<p>Reproducible floating point arithmetic is essential</p>
</section>

<section id="solution-verification" class="title-slide slide level1">
<h1>Solution verification</h1>
<p><code>ocean.stats</code></p>
<pre class="bash"><code>Step   Days   Energy/Mass [m2 s-2]     Mean Sea Level [m]   ...

   0   0.00   7.2161166068132286E-27   1.8190E-12           ...
  12   0.50   2.7781004671136538E-04   1.1369E-12           ...
  24   1.00   2.7734897826598717E-04   1.8190E-12           ...</code></pre>
<p>Based on global metrics (energy, mass, etc)</p>
</section>

<section id="diagnostic-verification" class="title-slide slide level1">
<h1>Diagnostic verification</h1>
<p><code>chksum_diag</code>:</p>
<pre><code>u-point: ocean_model-u
  min  = -6.7187595818683776E-03  max  =  3.3480219779204019E-02
  mean =  1.1239682303793666E-04  bits = 21851
v-point: ocean_model-v
  min  = -8.3469699425156359E-03  max  =  6.8420831486068704E-03 
  mean =  1.2076392816784489E-03  bits = 18606
h-point: ocean_model-h
  min  =  9.9999999999999915E-04  max  =  5.6265092225099863E+02
  mean =  3.6490088139048595E+02  bits = 18673 </code></pre>
<p>Min, max, mean, bit count for every diagnostic</p>
</section>

<section id="verification-testing" class="title-slide slide level1">
<h1>Verification Testing</h1>
<p><img data-src="img/mom_verify.svg" style="width:80.0%" alt="image" /></p>
<aside class="notes">
<ul>
<li>Also called "invariance tests"</li>
<li>Configured for different compilers, environments</li>
<li><dl>
<dt>Platform-independent:</dt>
<dd><ul>
<li>no reference answers</li>
<li>identical comparisons</li>
</ul>
</dd>
</dl></li>
<li>"Regression" test for reference code (e.g. <code>main</code>)</li>
</ul>
</aside>
</section>

<section id="verification-tests" class="title-slide slide level1">
<h1>Verification Tests</h1>
<table>
<thead>
<tr class="header">
<th>Test</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>grid</td>
<td>Symmetric/Asymmetric memory grids</td>
</tr>
<tr class="even">
<td>layout</td>
<td>1×1 and 2×1 domain decomposition</td>
</tr>
<tr class="odd">
<td>restart</td>
<td>Restart at mid-run</td>
</tr>
<tr class="even">
<td>dimension</td>
<td>Dimensional scaling</td>
</tr>
<tr class="odd">
<td>rotation</td>
<td>Index rotation</td>
</tr>
<tr class="even">
<td>openmp</td>
<td>OpenMP (single-thread)</td>
</tr>
</tbody>
</table>
</section>

<section id="validation-testing" class="title-slide slide level1">
<h1>Validation Testing</h1>
<p><img data-src="img/mom_validate.svg" alt="image" /></p>
<aside class="notes">
<ul>
<li>Specified for <em>our</em> machine</li>
<li><em>Does</em> have reference answers</li>
<li>Very strict testing</li>
</ul>
</aside>
</section>

<section id="production-runs" class="title-slide slide level1">
<h1>Production Runs</h1>
<p>Idealized and production configs (incl. publications)</p>
<ul>
<li>Ocean-only</li>
<li>Ocean - Sea Ice</li>
<li>Coupled (Atmosphere - Sea Ice - Ocean)</li>
</ul>
<p>Final Evaluation:</p>
<ul>
<li>Active GFDL development models</li>
</ul>
</section>

<section id="external-testing" class="title-slide slide level1">
<h1>External Testing</h1>
<p><img data-src="img/gitrepos.svg" style="width:50.0%" alt="image" /></p>
<aside class="notes">
<p>Merge to the <code>main</code> branch:</p>
<p>Code is synced across labs periodically</p>
<p>Other labs design their own regression suite</p>
<p>Any regressions are resolved collaboratively</p>
<p>We also have bi-weekly meetings and keep in touch regularly</p>
</aside>
</section>

<section id="testing-summary" class="title-slide slide level1">
<h1>Testing Summary</h1>
<ul>
<li>Automated Verification Tests
<ul>
<li>Small, designed to run on any system</li>
</ul></li>
<li>Regression Testing
<ul>
<li>61 tests, up to 500 cores, specialized facility</li>
</ul></li>
<li>Internal validation
<ul>
<li>Active production runs</li>
</ul></li>
<li>Cross-site review</li>
</ul>
</section>

<section id="floating-point-review" class="title-slide slide level1">
<h1>Floating Point Review</h1>
<p><a href="https://commons.wikimedia.org/wiki/File:Float_example.svg"><img data-src="img/ieee_float_fmt.svg" alt="image" /></a></p>
<p><span class="math display">\[\phi \equiv (-1)^{\color{yellow}s} \times 2^{\color{aquamarine}M}
   \times (1 + {\color{pink}\alpha})\]</span></p>
<ul>
<li>Smallest fractional diff: <span class="math inline">\(2^{-52} \approx 2.2 \times 10^{-16}\)</span></li>
<li>17 digits to uniquely specify a result</li>
</ul>
<aside class="notes">
<p>Things we ignore: - Inf and NaN - Denormals</p>
<p>We will return to negative zero.</p>
<p>Exponent manipulation is <em>associative</em> integer arithmetic</p>
</aside>
</section>

<section id="addition-associativity" class="title-slide slide level1">
<h1>Addition Associativity</h1>
<p>What is <span class="math inline">\(10^{-16} + 1 - 1\)</span>?</p>
<p><span class="math display">\[\begin{aligned}
(10^{-16} + 1) - 1 &amp;\equiv 0 \\
10^{-16} + (1 - 1) &amp;= 10^{-16}
\end{aligned}\]</span></p>
<p>Residuals below ULP (<span class="math inline">\(2\times10^{-16}\)</span>) are lost.</p>
<aside class="notes">
<p>ULP: Unit of least precision (or lowest bit)</p>
<p>10^-16 is below the current ULP (2x10^-16), so is lost in the first example.</p>
<p>Cancellation in the second summation shifts ULP, preserving 10^-16.</p>
</aside>
</section>

<section id="floating-residual" class="title-slide slide level1">
<h1>Floating residual</h1>
<p>Let <span class="math inline">\(s = 1 + 2 \times 10^{-16}\)</span>. What is <span class="math inline">\((s + 1) - 1\)</span>?</p>
<p><span class="math display">\[\begin{aligned}
s + 1 &amp;= 2 \\
(s + 1) - 1 &amp;= 1 \neq s
\end{aligned}\]</span></p>
<p>Manipulation of <span class="math inline">\(s\)</span> shifts ULP to <span class="math inline">\(4 \times 10^{-16}\)</span>.</p>
<aside class="notes">
<p>Nearly identical issue, but illustrates a 2x increase in ULP</p>
</aside>
</section>

<section id="multiplication-associativity" class="title-slide slide level1">
<h1>Multiplication associativity</h1>
<p>If <span class="math inline">\(a = b = 1.5\)</span>, and <span class="math inline">\(c = 1 + 2^{-52}\)</span>, then</p>
<p><span class="math display">\[\begin{aligned}
(a \times b) \times c &amp;\equiv 2.25 + 2^{-51} \\
a \times (b \times c) &amp;\equiv 2.25 + 2^{-50}
\end{aligned}\]</span></p>
<p>(Actual results depend on rounding rules)</p>
<aside class="notes">
<p>Multiplication is less volatile, but trailing bits can still be lost.</p>
<p>The fractional part can only increase the exponent, and at most only one bit is lost: (1 &lt;= 1.xxx * 1.xxx &lt; 4)</p>
<ul>
<li>NOTE: Exponents follow integer arithmetic, and are associative</li>
</ul>
</aside>
</section>

<section>
<section id="explicit-ordering" class="title-slide slide level1">
<h1>Explicit Ordering</h1>
<p>Ambiguous ordering is rejected:</p>
<p><span class="math display">\[x + y + z\]</span></p>
<p>Parentheses are <em>required</em>:</p>
<p><span class="math display">\[\begin{aligned}
(x + y) + z \\
x + (y + z)
\end{aligned}\]</span></p>
<p>Select to optimize accuracy and performance.</p>
<aside class="notes">
<p>Accuracy: Preserve residuals</p>
<p>Performance: Gather repeated values (for example)</p>
</aside>
</section>
<section id="implementation" class="slide level2">
<h2>Implementation</h2>
<p>GCC Fortran</p>
<pre class="sh"><code>gfortran -fprotect-parens ...    # default
gfortran -Ofast ...              # Sets -fno-protect-parens</code></pre>
<p>Intel Fortran</p>
<pre class="sh"><code>ifort -assume protect-parens     # Not default</code></pre>
<p>Note: Fortran requires this!</p>
</section></section>
<section id="parallel-summation" class="title-slide slide level1">
<h1>Parallel Summation</h1>
<p>Parentheses work, but can be problematic:</p>
<p><span class="math display">\[\sum{\phi} = (\phi_1 + (\phi_2 + ( \phi_3 + ... )))\]</span></p>
<p>We recommend fixed-precision summation:</p>
<p><a href="https://doi.org/10.1016/j.parco.2014.04.007"><img data-src="img/fixedprec.svg" alt="image" /></a></p>
<p>Absolutely <em>NO</em> <code>sum()</code> calls!</p>
<aside class="notes">
<p>Parentheses are OK for cumulant sums, but there are problems:</p>
<ul>
<li>Must gather to one rank/thread before summing</li>
<li>Cumulant errors depend on order, threaten accuracy</li>
</ul>
<p>Cumulant sums over multiple bins resolve these issues.</p>
<p>Hallberg and Adcroft, 2014: An Order-invariant Real-to-Integer Conversion Sum. Parallel Computing, 40(5-6), <a href="DOI:10.1016/j.parco.2014.04.007">DOI:10.1016/j.parco.2014.04.007</a></p>
</aside>
</section>

<section id="transcendentals" class="title-slide slide level1">
<h1>Transcendentals</h1>
<p>How is <code>sin(x)</code> computed?</p>
<p><span class="math display">\[f(48^\circ) = 2 \Omega \sin \left( \frac{48 \pi}{180} \right)\]</span></p>
<pre class="bash"><code>glibc 2.22: 0.108381727637274115E-03 (3F1C695FE71A3FE4)
      2.26: 0.108381727637274128E-03 (3F1C695FE71A3FE5)</code></pre>
<p>Other compilers may not even use libm!</p>
</section>

<section id="higher-order-powers" class="title-slide slide level1">
<h1>Higher order powers</h1>
<p>How to evaluate <span class="math inline">\(z^6\)</span>?</p>
<p>These forms are ambiguous:</p>
<pre class="fortran" data-trim=""><code>z6 = z * z * z * z * z * z</code></pre>
<p>Compilers may use libm <code>pow()</code>, also ambiguous.</p>
<p>We recommend:</p>
<pre><code>z3 = z * z * z
z6 = z3 * z3</code></pre>
<p>(Quiz: Why not <code>(z * z) * z</code>?)</p>
<aside class="notes">
<p><code>pow()</code> is likely to be implementation dependent.</p>
</aside>
</section>

<section>
<section id="negative-zero" class="title-slide slide level1">
<h1>Negative Zero</h1>
<p>Although <code>-0 == 0</code>, bitcounts will differ.</p>
<p><span class="math display">\[\begin{aligned}
x \times 0 = 
\begin{cases}
    0 &amp; \text{if $x \leq 0$} \\
   -0 &amp; \text{if $x &lt; 0$}
\end{cases}
\end{aligned}\]</span></p>
<p><span class="math inline">\(0 \Leftrightarrow -0\)</span> transitions can indicate volatility.</p>
<p>If all else fails: <code>-0. + 0. == 0.</code></p>
<aside class="notes">
<p>Challenge of -0: Identical to +0 for all practical purposes.</p>
<p>Even if we detect a <code>-0</code>, it may be more serious in production.</p>
<p>Examples of volatility:</p>
<ul>
<li>Incomplete initialization</li>
<li>Incomplete rotation</li>
</ul>
<p>Issues in halos are not uncommon.</p>
</aside>
</section>
<section id="subroundoff" class="slide level2">
<h2>Subroundoff</h2>
<p>Thickness-weighted mean:</p>
<p><span class="math display">\[\overline{\phi} = \frac{\sum \phi_i h_i}{\sum h_i}\]</span></p>
<p>What if all <span class="math inline">\(h_i = 0\)</span>? Use subroundoff:</p>
<p><span class="math display">\[\overline{\phi} = \frac{\sum \phi_i h_i}{\sum h_i + h_\text{sub}}\]</span></p>
<p><span class="math inline">\(h_\text{sub}\)</span> is small enough s.t. <span class="math inline">\(h_i + h_{sub} = h_i\)</span>.</p>
<aside class="notes">
<p>Not a bit reproducibility method, but relevant to how we manage such calculations.</p>
<p>I think this relies on throttling of <span class="math inline">\(h_i\)</span> to "angstroms".</p>
</aside>
</section></section>
<section id="associative-scaling" class="title-slide slide level1">
<h1>Associative Scaling</h1>
<p>Recall the floating point format</p>
<p><span class="math display">\[\phi \equiv (-1)^{\color{yellow}s} \times 2^{\color{yellow}M}
   \times (1 + {\color{yellow}\alpha})\]</span></p>
<p>Power-of-two multiplication is associative</p>
<p><span class="math display">\[2^N \times \phi \times 2^{-N} \equiv \phi\]</span></p>
<aside class="notes">
<p>... up to over/underflow of the exponent</p>
<ul>
<li>Fixed-precision sums must be unscaled to avoid over/underflow</li>
<li>Must un/rescale for external libraries (e.g. TEOS, CVMix)</li>
</ul>
</aside>
</section>

<section id="dimension-scaling" class="title-slide slide level1">
<h1>Dimension Scaling</h1>
<p>Fields rescaled by dimensions should be invariant</p>
<p><span class="math display">\[\begin{aligned}
u^{n+1} &amp;= u^{n} +  \Delta t \times \mathcal{F} \\
{\color{yellow}2^{L-T}} u^{n+1} &amp;= {\color{yellow}2^{L-T}} u^{n}
   + {\color{yellow}2^T} \Delta t
   \times {\color{yellow}2^{L - 2T}} \mathcal{F}
\end{aligned}\]</span></p>
</section>

<section id="gfd-scaling" class="title-slide slide level1">
<h1>GFD Scaling</h1>
<p><span class="math display">\[\begin{aligned}
u_t + u u_x + v u_y &amp;= -g h_x \\
v_t + u v_x + v v_y &amp;= -g h_y \\
h_t + h u_x + h v_y &amp;= 0 \\
\end{aligned}\]</span></p>
<table>
<tbody>
<tr class="odd">
<td>Dimensions:
<ul>
<li><span class="math inline">\(L\)</span> (horiz. length)</li>
<li><span class="math inline">\(T\)</span> (time)</li>
<li><span class="math inline">\(H\)</span> (layer thickness)</li>
</ul></td>
<td>Invariants:
<ul>
<li><span class="math inline">\(\left[ u, v \right] = L T^{-1}\)</span></li>
<li><span class="math inline">\(\left[ g \right] = L^2 T^{-2} H^{-1}\)</span></li>
</ul></td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>Shallow water eqns, a lower dimensional ocean model.</p>
</aside>
</section>

<section id="mom6-dimensionality" class="title-slide slide level1">
<h1>MOM6 Dimensionality</h1>
<table>
<thead>
<tr class="header">
<th>Unit</th>
<th>Scaling</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>s</td>
<td>T</td>
<td>Time</td>
</tr>
<tr class="even">
<td>m</td>
<td>L</td>
<td>Horizontal length</td>
</tr>
<tr class="odd">
<td>m</td>
<td>H</td>
<td>Layer thickness</td>
</tr>
<tr class="even">
<td>m</td>
<td>Z</td>
<td>Vertical length</td>
</tr>
<tr class="odd">
<td>kg/m3</td>
<td>R</td>
<td>Density</td>
</tr>
<tr class="even">
<td>J/kg</td>
<td>Q</td>
<td>Enthalpy</td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>The currently tracked units are shown in this table.</p>
<p>Salinity is a potential scaling</p>
</aside>
</section>

<section id="horizontal-rotation" class="title-slide slide level1">
<h1>Horizontal Rotation</h1>
<p><img data-src="img/rotated_field.png" alt="image" /></p>
<p>Rotate input fields, forcing, coordinates.</p>
<p><code>(x,y)</code> and <code>(u,v)</code> describe first and second index</p>
<aside class="notes">
<p>We call this an "index rotation" because even the coordinates are rotated.</p>
<ul>
<li>Fields, grid, topography are rotated</li>
<li>Even "latitude" and "longitude" are rotated.</li>
<li>(X, Y) and (U, V) refer to the first and second index, not physical directions.</li>
</ul>
<p>This is why I resist calling it a "solid body rotation".</p>
</aside>
</section>

<section id="index-rotation" class="title-slide slide level1">
<h1>Index Rotation</h1>
<table>
<tbody>
<tr class="odd">
<td><img data-src="img/rotate_grid1.svg" style="width:70.0%" alt="image" /></td>
<td><img data-src="img/rotate_grid2.svg" style="width:70.0%" alt="image" /></td>
</tr>
</tbody>
</table>
<p><img data-src="img/rotate_mem.svg" style="width:65.0%" alt="image" /></p>
<aside class="notes">
<p>Perhaps "rotation" is not the best term, since it is more like a reordering of the array.</p>
<p>But I think it is accurate to call it a rotation of the index map, hence the term "index rotation".</p>
</aside>
</section>

<section id="applying-the-rotation" class="title-slide slide level1">
<h1>Applying the Rotation</h1>
<table>
<tbody>
<tr class="odd">
<td><p><img data-src="img/rotate_procedure.svg" alt="image" /></p></td>
<td><p>Read inputs on coupler grid</p>
<p>Move to rotated MOM6 grid</p>
<p>De-rotate fields sent back to coupler and output</p></td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>All rotations are handled internally.</p>
<p>Users do not need to manually apply any rotations.</p>
</aside>
</section>

<section id="rotational-pairs" class="title-slide slide level1">
<h1>Rotational Pairs</h1>
<p>For 90° rotations:</p>
<table>
<tbody>
<tr class="odd">
<td>Scalar</td>
<td><span class="math inline">\(\phi(I,J) = \phi(j, N-i)\)</span></td>
</tr>
<tr class="even">
<td>Array pair</td>
<td><ul>
<li><span class="math inline">\(\phi_u(I, J) = \phi_v(j, N-i)\)</span></li>
<li><span class="math inline">\(\phi_v(I, J) = \phi_u(j, N-i)\)</span></li>
</ul></td>
</tr>
<tr class="odd">
<td>Vector</td>
<td><ul>
<li><span class="math inline">\(u(I, J) =  v(j, N-i)\)</span></li>
<li><span class="math inline">\(v(I, J) = -u(j, N-i)\)</span></li>
</ul></td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>More generally, a rotation is a reverse+transpose of the fields</p>
</aside>
</section>

<section id="rotational-consistency" class="title-slide slide level1">
<h1>Rotational Consistency</h1>
<pre class="fortran"><code>beta_topo_x = -CS%MEKE_topographic_beta * FatH * 0.5 * ( &amp;
              (G%bathyT(i+1,j)-G%bathyT(i,j)) * G%IdxCu(I,j)  &amp;
          / max(G%bathyT(i+1,j),G%bathyT(i,j), GV%H_subroundoff) &amp;
      +       (G%bathyT(i,j)-G%bathyT(i-1,j)) * G%IdxCu(I-1,j) &amp;
          / max(G%bathyT(i,j),G%bathyT(i-1,j), GV%H_subroundoff) )

beta_topo_y = -CS%MEKE_topographic_beta * FatH * 0.5 * ( &amp;
              (G%bathyT(i,j+1)-G%bathyT(i,j)) * G%IdyCv(i,J)  &amp;
          / max(G%bathyT(i,j+1),G%bathyT(i,j), GV%H_subroundoff) + &amp;
              (G%bathyT(i,j)-G%bathyT(i,j-1)) * G%IdyCv(i,J-1) &amp;
          / max(G%bathyT(i,j),G%bathyT(i,j-1), GV%H_subroundoff) )</code></pre>
<p>Index rotation ensures directional consistency</p>
</section>

<section id="invariant-stencils" class="title-slide slide level1">
<h1>Invariant stencils</h1>
<p><span class="math inline">\(\phi^{(c)}_{i,j} = \frac{1}{4} (\phi_A + \phi_B + \phi_C + \phi_D)\)</span></p>
<p><img data-src="img/stencil.svg" class="float float" alt="image" /></p>
<table>
<tbody>
<tr class="odd">
<td><p><img data-src="img/stencil1.svg" alt="image" /></p></td>
<td><p><span class="math inline">\(\frac{1}{4} ( (\phi_A + \phi_B) + (\phi_C + \phi_D) )\)</span></p>
<p><span class="math inline">\(\frac{1}{4} ( (\phi_A + \phi_C) + (\phi_B + \phi_D) )\)</span></p></td>
</tr>
<tr class="even">
<td><img data-src="img/stencil2.svg" alt="image" /></td>
<td><span class="math inline">\(\frac{1}{4} ( (\phi_A + \phi_D) + (\phi_B + \phi_C) )\)</span></td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>Example: Interpolation from vertex to center point</p>
<p>The ideal outcome is to construct the stencil in a rotationally invariant form.</p>
<p>The first example will evaluate its terms in a different order after a quarter turn.</p>
<p>The second form is rotationally invariant to any number of quarter turns.</p>
</aside>
</section>

<section id="rotational-ordering" class="title-slide slide level1">
<h1>Rotational ordering</h1>
<pre class="fortran"><code>subroutine advect_tracer(...)
   ! ...
   x_first = modulo(turns, 2) == 1
   if (x_first) then
      call advect_x(...)
      call advect_y(...)
   else
      call advect_y(...)
      call advect_x(...)
   endif
end subroutine advect_tracer</code></pre>
<p>When all else fails, reorder the algorithm.</p>
<aside class="notes">
<p>This is a last resort, but may be required if complexity has grown out of control.</p>
</aside>
</section>

<section>
<section id="examples" class="title-slide slide level1">
<h1>Examples</h1>

</section>
<section id="dimensional-scaling-example" class="slide level2">
<h2>Dimensional scaling example</h2>
<p><a href="https://github.com/NOAA-GFDL/MOM6/pull/921">https://github.com/NOAA-GFDL/MOM6/pull/921</a></p>
<pre class="fortran"><code>Kd_lay(i,j,k-1) = Kd_lay(i,j,k-1) + 0.5**KS_extra(i,K)
Kd_lay(i,j,k)   = Kd_lay(i,j,k)   + 0.5**KS_extra(i,K)</code></pre>
<p><span class="math inline">\(\ldots + \left(\tfrac{1}{2}\right)^{\kappa_S}\)</span>?</p>
<aside class="notes">
<p>Actually discovered during implementation of the dimensional scaling, rather than detected by the dimensional scaling test. But it's the sort of thing that would have been found...</p>
</aside>
</section>
<section id="rotational-example" class="slide level2">
<h2>Rotational example</h2>
<p><a href="https://github.com/NOAA-GFDL/MOM6/pull/1050">https://github.com/NOAA-GFDL/MOM6/pull/1050</a></p>
<pre class="fortran"><code>subroutine thickness_diffuse_full
   !...
   Work_u(I,j) = Work_u(I,j) + G_scale * (...)
   Work_v(i,J) = Work_v(i,J) - G_scale * (...)
   !...
end subroutine thickness_diffuse_full</code></pre>
</section></section>
<section id="summary" class="title-slide slide level1">
<h1>Summary</h1>
<ul>
<li>Bit reproducibility is essential, and achievable!</li>
<li>Enables aggressive regression testing
<ul>
<li>Dimensional consistency</li>
<li>Rotationally symmetric solvers</li>
</ul></li>
<li>Methods for bit reproducibility
<ul>
<li>Use parentheses for arithmetic operations.</li>
<li>Avoid ambiguous intrinsics: <code>sum()</code>, <code>sin()</code>, ...</li>
</ul></li>
</ul>
</section>
    </div>
  </div>

  <script src="./reveal.js/dist/reveal.js"></script>
  <script src="./reveal.js/plugin/math/math.js"></script>
  <script src="./reveal.js/plugin/notes/notes.js"></script>
  <script src="./reveal.js/plugin/highlight/highlight.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Display the page number of the current slide
        slideNumber: true,
        // Push each slide change to the browser history
        history: true,
        math: {
          //mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js',
          //config: 'TeX-AMS_MML_HTMLorMML',
          mathjax: 'https://cdn.jsdelivr.net/gh/mathjax/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          "HTML-CSS": {
              preferredFont: "Neo-Euler",
              //preferredFont: "Asana-Math",
          },
          //TeX: {
          //  inlineMath: [['\\(','\\)']],
          //  displayMath: [['\\[','\\]']],
          //  balanceBraces: true,
          //  processEscapes: false,
          //  processRefs: true,
          //  processEnvironments: true,
          //  preview: 'TeX',
          //  skipTags: ['script','noscript','style','textarea','pre','code'],
          //  ignoreClass: 'tex2jax_ignore',
          //  processClass: 'tex2jax_process'
          //},
        },

        // Optional reveal.js plugins
        dependencies: [
          { src: './reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: './reveal.js/plugin/zoom/zoom.js', async: true },
          { src: './reveal.js/plugin/notes/notes.js', async: true }
        ],
        plugins : [ RevealMath, RevealNotes, RevealHighlight],
      });
    </script>
    </body>
</html>
